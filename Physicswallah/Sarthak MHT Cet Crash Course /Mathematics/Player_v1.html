<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DEV'S VIDEO PLAYER</title>
    <link rel="icon" type="image/jpeg" href="https://telegra.ph/file/53696585b88da5376d48c.jpg">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.6.12/plyr.css" />
    <link href="https://fonts.googleapis.com/css?family=Poppins|Quattrocento+Sans" rel="stylesheet"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script src="https://cdn.plyr.io/3.6.12/plyr.js"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script> 
    <style type="text/css" media="screen">
        /* Your CSS styles here */
    </style>
</head>
<body>
    <!-- Your loading indicator -->
    <div id="loading" class="loading">
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
    </div>
	
    <div class="plyr__video-wrapper">
        <video crossorigin="" playsinline="" id="videoContainer" style="background-color: #0A0909;" preload="auto">
            <source src="">
        </video>
    </div>
	
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Fetch lecture code from quality-select.html
            fetch('quality-select.html')
                .then(response => response.text())
                .then(data => {
                    // Extract the lecture code from the fetched HTML
                    const lectureCodeRegex = /<option value="(.+?)"/;
                    const match = data.match(lectureCodeRegex);
                    if (match && match[1]) {
                        const lectureCode = match[1];

                        // Construct the video source URL with the lecture code
                        const videoUrl = `https://d1d34p8vz63oiq.cloudfront.net/${lectureCode}/master.mpd`;

                        // Initialize the player with the retrieved lecture code
                        initializePlayer(videoUrl);
                    } else {
                        console.error('Lecture code not found in quality-select.html');
                    }
                })
                .catch(error => console.error('Error fetching HTML:', error));
        });

        function initializePlayer(videoUrl) {
            fetchClearkeysData(videoUrl)
                .then(clearkeysData => {
                    // Once clearkeysData is fetched, initialize the player
                    initializeDashPlayer(videoUrl, clearkeysData);
                })
                .catch(error => console.error('Error fetching clearkeysData:', error));
        }

        function fetchClearkeysData(videoUrl) {
            return fetch(videoUrl)
                .then(response => response.text())
                .then(htmlContent => {
                    // Parse HTML content to extract clearkeysData
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;

                    // Find the script tag containing clearkeysData
                    const scriptElement = tempDiv.querySelector('script:not([src])');

                    if (scriptElement && scriptElement.textContent.includes('const clearkeysData')) {
                        // Extract clearkeysData object
                        const startIndex = scriptElement.textContent.indexOf('const clearkeysData = ') + 'const clearkeysData = '.length;
                        const endIndex = scriptElement.textContent.indexOf(';', startIndex);
                        const clearkeysDataStr = scriptElement.textContent.substring(startIndex, endIndex);

                        // Parse clearkeysData object
                        const clearkeysData = JSON.parse(clearkeysDataStr);
                        return clearkeysData;
                    } else {
                        console.error('Script tag containing clearkeysData not found');
                        return Promise.reject('Script tag containing clearkeysData not found');
                    }
                });
        }

        function initializeDashPlayer(videoUrl, clearkeysData) {
            const video = document.getElementById("videoContainer");
            const videoSource = document.querySelector("#videoContainer source");

            // Set the source URL
            videoSource.src = videoUrl;

            const dash = dashjs.MediaPlayer().create();
            const protData = {
                "org.w3.clearkey": {
                    "clearkeys": clearkeysData
                }
            };

            dash.setProtectionData(protData);
            dash.on("streamInitialized", function() {
                const bodyElement = document.querySelector("body");
                const loadingElement = document.getElementById("loading");
                loadingElement.style.display = "none";
                bodyElement.style.visibility = "visible";
                const availableQualities = dash.getBitrateInfoListFor("video").map(l => l.height);

                const defaultOptions = {
                    quality: {
                        default: availableQualities[0].height,
                        options: availableQualities,
                        forced: true,
                        onChange: function(newQuality) {
                            dash.getBitrateInfoListFor("video").forEach(level => {
                                if (level.height === newQuality) {
                                    dash.setQualityFor("video", level.qualityIndex);
                                }
                            });
                        }
                    },
                    autoplay: false,
                    muted: false,
                    loop: { active: false },
                    captions: { active: false, update: false }
                };

                const player = new Plyr(video, defaultOptions);
                window.player = player;
                window.dash = dash;
            });

            dash.attachView(video);
            dash.initialize(video, videoUrl, false);
        }
    </script>

    <!-- Your additional script to prevent context menu and other interactions -->
    <script>
        document.addEventListener("contextmenu", function (e) { e.preventDefault() });
        document.addEventListener('keydown', function (e) {
            if (
                e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.key === 'u') ||
                (e.ctrlKey && e.key === 'U') ||
                (e.ctrlKey && e.key === 's') ||
                (e.ctrlKey && e.key === 'S') ||
                e.ctrlKey ||
                e.shiftKey ||
                e.altKey
            ) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
