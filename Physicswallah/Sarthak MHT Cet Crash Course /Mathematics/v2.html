<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.6.12/plyr.css">
    <script src="https://cdn.plyr.io/3.6.12/plyr.js"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
</head>
<body>
    <div id="loading" class="loading">
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
    </div>
    
    <div class="plyr__video-wrapper">
        <video crossorigin playsinline id="videoContainer" style="background-color: #0A0909;" preload="auto"></video>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetch('quality-select.html')
                .then(response => response.text())
                .then(data => {
                    const lectureCodeRegex = /lectureCode\s*=\s*"([^"]+)"/;
                    const match = data.match(lectureCodeRegex);
                    if (match && match[1]) {
                        const lectureCode = match[1];
                        const lectureLink = `https://d1d34p8vz63oiq.cloudfront.net/${lectureCode}/master.mpd`;
                        initializePlayer(lectureLink);
                    } else {
                        console.error('Lecture code not found in quality-select.html');
                    }
                })
                .catch(error => console.error('Error fetching lecture code:', error));
        });

        function initializePlayer(lectureLink) {
            const video = document.getElementById("videoContainer");
            const dash = dashjs.MediaPlayer().create();
            const defaultOptions = {
                autoplay: false,
                muted: false,
                loop: {
                    active: false
                },
                speed: {
                    selected: 1,
                    options: [1, 1.25, 1.5, 2, 2.5, 3, 3.25, 3.5, 4]
                },
                captions: {
                    active: true,
                    update: true
                },
                quality: {
                    default: 0,
                    options: []
                },
                previewThumbnails: {
                    enabled: true,
                    src: '' // Update with your thumbnail source
                },
                tooltips: {
                    controls: true,
                    seek: true
                }
            };

            fetchClearkeys(lectureLink);

            function fetchClearkeys(lectureLink) {
                fetch(lectureLink)
                    .then(response => response.text())
                    .then(htmlContent => {
                        const clearkeysRegex = /const protData = ({.*?})/;
                        const match = htmlContent.match(clearkeysRegex);
                        if (match && match[1]) {
                            const clearkeysJson = match[1];
                            const clearkeysData = JSON.parse(clearkeysJson);

                            const prodata = {
                                "org.w3.clearkey": {
                                    "clearkeys": clearkeysData
                                }
                            };

                            dash.initialize(video, lectureLink, false);
                            dash.setProtectionData(prodata);

                            dash.on("streamInitialized", function() {
                                const loadingElement = document.getElementById("loading");
                                loadingElement.style.display = "none";
                                
                                const availableQualities = dash.getBitrateInfoListFor("video").map((l) => l.height);
                                defaultOptions.quality.options = availableQualities;

                                const player = new Plyr(video, defaultOptions);
                            });
                            dash.attachView(video);
                        } else {
                            console.error('Clearkeys data not found in main lecture link');
                        }
                    })
                    .catch(error => console.error('Error fetching clearkeys:', error));
            }
        }
    </script>
</body>
</html>
